# Elasticsearch 入门实用指南

## 一、简介

Elasticsearch（简称 **ES**）是一个基于 Lucene 的分布式搜索与分析引擎，用于处理大规模的结构化与非结构化数据。常用于：

* 全文搜索（Search）
* 日志分析（ELK Stack）
* 数据统计与聚合（Aggregation）

---

## 二、安装与搭建

### 1. Docker 快速搭建（推荐）

```bash
docker pull elasticsearch:8.15.0
docker network create es-net
docker run -d --name es01 --net es-net -p 9200:9200 -e "discovery.type=single-node" -e "xpack.security.enabled=false" elasticsearch:8.15.0
```

浏览器访问：[http://localhost:9200](http://localhost:9200)

返回类似：

```json
{
  "name": "es01",
  "cluster_name": "docker-cluster",
  "version": { "number": "8.15.0" }
}
```

表示启动成功。

### 2. 本地安装（手动）

* 从官网下载安装包：[https://www.elastic.co/downloads/elasticsearch](https://www.elastic.co/downloads/elasticsearch)
* 解压后运行：

  ```bash
  ./bin/elasticsearch
  ```
* 默认端口：`9200`

### 3. 搭配 Kibana（可选）

```bash
docker run -d --name kibana --net es-net -p 5601:5601 -e ELASTICSEARCH_HOSTS=http://es01:9200 kibana:8.15.0
```

访问：[http://localhost:5601](http://localhost:5601)

---

## 三、核心概念

| 概念     | 含义                       | 类比     |
| -------- | -------------------------- | -------- |
| Index    | 索引，相当于数据库的表     | 数据表   |
| Document | 文档，相当于表的一行数据   | 行记录   |
| Field    | 字段，相当于表的列         | 列       |
| Mapping  | 字段定义和类型             | 表结构   |
| Analyzer | 分词器，控制文本如何被切分 | 索引策略 |

---

## 四、基本操作（REST API）

### 1. 创建索引

```bash
PUT /users
{
  "mappings": {
    "properties": {
      "name": {"type": "text"},
      "age": {"type": "integer"},
      "city": {"type": "keyword"}
    }
  }
}
```

### 2. 插入数据

```bash
POST /users/_doc/1
{
  "name": "Alice",
  "age": 25,
  "city": "Tokyo"
}
```

### 3. 查询数据

```bash
GET /users/_search
{
  "query": {
    "match": {"name": "Alice"}
  }
}
```

### 4. 更新数据

```bash
POST /users/_update/1
{
  "doc": {"age": 26}
}
```

### 5. 删除数据

```bash
DELETE /users/_doc/1
```

---

## 五、搜索与过滤

### 1. match 查询

```bash
GET /users/_search
{
  "query": { "match": { "city": "Tokyo" } }
}
```

### 2. bool 查询（组合）

```bash
GET /users/_search
{
  "query": {
    "bool": {
      "must": [ {"match": {"city": "Tokyo"}} ],
      "filter": [ {"range": {"age": {"gte": 20, "lte": 30}}} ]
    }
  }
}
```

### 3. 聚合统计

```bash
GET /users/_search
{
  "size": 0,
  "aggs": {
    "avg_age": {"avg": {"field": "age"}}
  }
}
```

---

## 六、连接与使用（Python 示例）

### 1. 安装依赖

```bash
pip install elasticsearch
```

### 2. Python 连接示例

```python
from elasticsearch import Elasticsearch

# 连接 ES（关闭安全验证）
es = Elasticsearch(hosts=["http://localhost:9200"])

# 插入文档
doc = {"name": "Alice", "age": 25, "city": "Tokyo"}
es.index(index="users", id=1, document=doc)

# 查询文档
res = es.search(index="users", query={"match": {"city": "Tokyo"}})
print(res["hits"]["hits"])
```

---

## 七、常用命令速查表

| 操作         | 方法   | 示例                           |
| ------------ | ------ | ------------------------------ |
| 查看所有索引 | GET    | `/_cat/indices?v`              |
| 查看集群健康 | GET    | `/_cluster/health`             |
| 删除索引     | DELETE | `/users`                       |
| 测试分词     | GET    | `/_analyze?text=hello%20world` |
| 批量写入     | POST   | `/_bulk`                       |
| 查看 mapping | GET    | `/users/_mapping`              |

---

## 八、调优与建议

| 项目            | 建议                                       |
| --------------- | ------------------------------------------ |
| 分片设置        | 小规模数据：1–3 分片即可                   |
| keyword vs text | 过滤用 keyword，全文检索用 text            |
| 分页性能        | 大分页用 `search_after` 代替 `from + size` |
| 写入性能        | 批量写入 `_bulk` API，提高速率             |
| 查询优化        | 多用 `filter` 替代 `must` 进行精确过滤     |

---

## 九、常见问题

| 问题             | 原因                       | 解决方案                            |
| ---------------- | -------------------------- | ----------------------------------- |
| 启动后访问被拒绝 | 安全验证未关闭             | 设置 `xpack.security.enabled=false` |
| 查询无结果       | mapping 不匹配或分词不一致 | 使用 `analyze` 查看分词结果         |
| 性能慢           | 分片过多、分页太深         | 降低分片数或使用 `search_after`     |

---

## 🔟 常见业务场景示例

### 1. 全文搜索（电商、知识库等）

```bash
GET /products/_search
{
  "query": {
    "multi_match": {
      "query": "苹果手机",
      "fields": ["title", "description"]
    }
  },
  "highlight": {
    "fields": {"title": {}, "description": {}}
  }
}
```

* 用途：匹配商品或文章标题、描述。
* 可搭配 `highlight` 高亮显示匹配词。

### 2. 日志分析（ELK 常见场景）

```bash
GET /logs-*/_search
{
  "query": {
    "bool": {
      "filter": [
        {"term": {"level": "error"}},
        {"range": {"@timestamp": {"gte": "now-1d/d"}}}
      ]
    }
  },
  "aggs": {
    "by_service": {"terms": {"field": "service.keyword"}}
  }
}
```

* 聚合统计不同服务的错误日志数量。
* 常与 Kibana 搭配可视化展示。

### 3. 用户行为分析

```bash
GET /events/_search
{
  "size": 0,
  "aggs": {
    "daily_active_users": {
      "date_histogram": {
        "field": "timestamp",
        "calendar_interval": "day"
      },
      "aggs": {
        "unique_users": {"cardinality": {"field": "user_id"}}
      }
    }
  }
}
```

* 用途：统计每日活跃用户数（DAU）。

### 4. 自动补全（搜索建议）

```bash
GET /suggest-demo/_search
{
  "suggest": {
    "product-suggest": {
      "prefix": "iph",
      "completion": {"field": "suggest"}
    }
  }
}
```

* 使用 `completion` 字段类型实现自动补全功能。

### 5. 地理位置搜索

```bash
GET /stores/_search
{
  "query": {
    "bool": {
      "filter": {
        "geo_distance": {
          "distance": "5km",
          "location": {"lat": 35.6895, "lon": 139.6917}
        }
      }
    }
  }
}
```

* 用途：查找距离用户当前位置 5 公里内的门店。

---

## 🔚 总结

* **1 天掌握**：基础 CRUD 与查询 DSL；
* **1 周熟悉**：聚合、mapping、性能调优；
* **1 月精通**：集群管理与架构优化。

> 💡 提示：ES 的一切操作都是基于 REST API。掌握 API 思路后，其他语言的客户端都能轻松迁移。