# Elasticsearch å…¥é—¨å®ç”¨æŒ‡å—

## ä¸€ã€ç®€ä»‹

Elasticsearchï¼ˆç®€ç§° **ES**ï¼‰æ˜¯ä¸€ä¸ªåŸºäº Lucene çš„åˆ†å¸ƒå¼æœç´¢ä¸åˆ†æå¼•æ“ï¼Œç”¨äºå¤„ç†å¤§è§„æ¨¡çš„ç»“æ„åŒ–ä¸éç»“æ„åŒ–æ•°æ®ã€‚å¸¸ç”¨äºï¼š

* å…¨æ–‡æœç´¢ï¼ˆSearchï¼‰
* æ—¥å¿—åˆ†æï¼ˆELK Stackï¼‰
* æ•°æ®ç»Ÿè®¡ä¸èšåˆï¼ˆAggregationï¼‰

---

## äºŒã€å®‰è£…ä¸æ­å»º

### 1. Docker å¿«é€Ÿæ­å»ºï¼ˆæ¨èï¼‰

```bash
docker pull elasticsearch:8.15.0
docker network create es-net
docker run -d --name es01 --net es-net -p 9200:9200 -e "discovery.type=single-node" -e "xpack.security.enabled=false" elasticsearch:8.15.0
```

æµè§ˆå™¨è®¿é—®ï¼š[http://localhost:9200](http://localhost:9200)

è¿”å›ç±»ä¼¼ï¼š

```json
{
  "name": "es01",
  "cluster_name": "docker-cluster",
  "version": { "number": "8.15.0" }
}
```

è¡¨ç¤ºå¯åŠ¨æˆåŠŸã€‚

### 2. æœ¬åœ°å®‰è£…ï¼ˆæ‰‹åŠ¨ï¼‰

* ä»å®˜ç½‘ä¸‹è½½å®‰è£…åŒ…ï¼š[https://www.elastic.co/downloads/elasticsearch](https://www.elastic.co/downloads/elasticsearch)
* è§£å‹åè¿è¡Œï¼š

  ```bash
  ./bin/elasticsearch
  ```
* é»˜è®¤ç«¯å£ï¼š`9200`

### 3. æ­é… Kibanaï¼ˆå¯é€‰ï¼‰

```bash
docker run -d --name kibana --net es-net -p 5601:5601 -e ELASTICSEARCH_HOSTS=http://es01:9200 kibana:8.15.0
```

è®¿é—®ï¼š[http://localhost:5601](http://localhost:5601)

---

## ä¸‰ã€æ ¸å¿ƒæ¦‚å¿µ

| æ¦‚å¿µ     | å«ä¹‰                       | ç±»æ¯”     |
| -------- | -------------------------- | -------- |
| Index    | ç´¢å¼•ï¼Œç›¸å½“äºæ•°æ®åº“çš„è¡¨     | æ•°æ®è¡¨   |
| Document | æ–‡æ¡£ï¼Œç›¸å½“äºè¡¨çš„ä¸€è¡Œæ•°æ®   | è¡Œè®°å½•   |
| Field    | å­—æ®µï¼Œç›¸å½“äºè¡¨çš„åˆ—         | åˆ—       |
| Mapping  | å­—æ®µå®šä¹‰å’Œç±»å‹             | è¡¨ç»“æ„   |
| Analyzer | åˆ†è¯å™¨ï¼Œæ§åˆ¶æ–‡æœ¬å¦‚ä½•è¢«åˆ‡åˆ† | ç´¢å¼•ç­–ç•¥ |

---

## å››ã€åŸºæœ¬æ“ä½œï¼ˆREST APIï¼‰

### 1. åˆ›å»ºç´¢å¼•

```bash
PUT /users
{
  "mappings": {
    "properties": {
      "name": {"type": "text"},
      "age": {"type": "integer"},
      "city": {"type": "keyword"}
    }
  }
}
```

### 2. æ’å…¥æ•°æ®

```bash
POST /users/_doc/1
{
  "name": "Alice",
  "age": 25,
  "city": "Tokyo"
}
```

### 3. æŸ¥è¯¢æ•°æ®

```bash
GET /users/_search
{
  "query": {
    "match": {"name": "Alice"}
  }
}
```

### 4. æ›´æ–°æ•°æ®

```bash
POST /users/_update/1
{
  "doc": {"age": 26}
}
```

### 5. åˆ é™¤æ•°æ®

```bash
DELETE /users/_doc/1
```

---

## äº”ã€æœç´¢ä¸è¿‡æ»¤

### 1. match æŸ¥è¯¢

```bash
GET /users/_search
{
  "query": { "match": { "city": "Tokyo" } }
}
```

### 2. bool æŸ¥è¯¢ï¼ˆç»„åˆï¼‰

```bash
GET /users/_search
{
  "query": {
    "bool": {
      "must": [ {"match": {"city": "Tokyo"}} ],
      "filter": [ {"range": {"age": {"gte": 20, "lte": 30}}} ]
    }
  }
}
```

### 3. èšåˆç»Ÿè®¡

```bash
GET /users/_search
{
  "size": 0,
  "aggs": {
    "avg_age": {"avg": {"field": "age"}}
  }
}
```

---

## å…­ã€è¿æ¥ä¸ä½¿ç”¨ï¼ˆPython ç¤ºä¾‹ï¼‰

### 1. å®‰è£…ä¾èµ–

```bash
pip install elasticsearch
```

### 2. Python è¿æ¥ç¤ºä¾‹

```python
from elasticsearch import Elasticsearch

# è¿æ¥ ESï¼ˆå…³é—­å®‰å…¨éªŒè¯ï¼‰
es = Elasticsearch(hosts=["http://localhost:9200"])

# æ’å…¥æ–‡æ¡£
doc = {"name": "Alice", "age": 25, "city": "Tokyo"}
es.index(index="users", id=1, document=doc)

# æŸ¥è¯¢æ–‡æ¡£
res = es.search(index="users", query={"match": {"city": "Tokyo"}})
print(res["hits"]["hits"])
```

---

## ä¸ƒã€å¸¸ç”¨å‘½ä»¤é€ŸæŸ¥è¡¨

| æ“ä½œ         | æ–¹æ³•   | ç¤ºä¾‹                           |
| ------------ | ------ | ------------------------------ |
| æŸ¥çœ‹æ‰€æœ‰ç´¢å¼• | GET    | `/_cat/indices?v`              |
| æŸ¥çœ‹é›†ç¾¤å¥åº· | GET    | `/_cluster/health`             |
| åˆ é™¤ç´¢å¼•     | DELETE | `/users`                       |
| æµ‹è¯•åˆ†è¯     | GET    | `/_analyze?text=hello%20world` |
| æ‰¹é‡å†™å…¥     | POST   | `/_bulk`                       |
| æŸ¥çœ‹ mapping | GET    | `/users/_mapping`              |

---

## å…«ã€è°ƒä¼˜ä¸å»ºè®®

| é¡¹ç›®            | å»ºè®®                                       |
| --------------- | ------------------------------------------ |
| åˆ†ç‰‡è®¾ç½®        | å°è§„æ¨¡æ•°æ®ï¼š1â€“3 åˆ†ç‰‡å³å¯                   |
| keyword vs text | è¿‡æ»¤ç”¨ keywordï¼Œå…¨æ–‡æ£€ç´¢ç”¨ text            |
| åˆ†é¡µæ€§èƒ½        | å¤§åˆ†é¡µç”¨ `search_after` ä»£æ›¿ `from + size` |
| å†™å…¥æ€§èƒ½        | æ‰¹é‡å†™å…¥ `_bulk` APIï¼Œæé«˜é€Ÿç‡             |
| æŸ¥è¯¢ä¼˜åŒ–        | å¤šç”¨ `filter` æ›¿ä»£ `must` è¿›è¡Œç²¾ç¡®è¿‡æ»¤     |

---

## ä¹ã€å¸¸è§é—®é¢˜

| é—®é¢˜             | åŸå›                        | è§£å†³æ–¹æ¡ˆ                            |
| ---------------- | -------------------------- | ----------------------------------- |
| å¯åŠ¨åè®¿é—®è¢«æ‹’ç» | å®‰å…¨éªŒè¯æœªå…³é—­             | è®¾ç½® `xpack.security.enabled=false` |
| æŸ¥è¯¢æ— ç»“æœ       | mapping ä¸åŒ¹é…æˆ–åˆ†è¯ä¸ä¸€è‡´ | ä½¿ç”¨ `analyze` æŸ¥çœ‹åˆ†è¯ç»“æœ         |
| æ€§èƒ½æ…¢           | åˆ†ç‰‡è¿‡å¤šã€åˆ†é¡µå¤ªæ·±         | é™ä½åˆ†ç‰‡æ•°æˆ–ä½¿ç”¨ `search_after`     |

---

## ğŸ”Ÿ å¸¸è§ä¸šåŠ¡åœºæ™¯ç¤ºä¾‹

### 1. å…¨æ–‡æœç´¢ï¼ˆç”µå•†ã€çŸ¥è¯†åº“ç­‰ï¼‰

```bash
GET /products/_search
{
  "query": {
    "multi_match": {
      "query": "è‹¹æœæ‰‹æœº",
      "fields": ["title", "description"]
    }
  },
  "highlight": {
    "fields": {"title": {}, "description": {}}
  }
}
```

* ç”¨é€”ï¼šåŒ¹é…å•†å“æˆ–æ–‡ç« æ ‡é¢˜ã€æè¿°ã€‚
* å¯æ­é… `highlight` é«˜äº®æ˜¾ç¤ºåŒ¹é…è¯ã€‚

### 2. æ—¥å¿—åˆ†æï¼ˆELK å¸¸è§åœºæ™¯ï¼‰

```bash
GET /logs-*/_search
{
  "query": {
    "bool": {
      "filter": [
        {"term": {"level": "error"}},
        {"range": {"@timestamp": {"gte": "now-1d/d"}}}
      ]
    }
  },
  "aggs": {
    "by_service": {"terms": {"field": "service.keyword"}}
  }
}
```

* èšåˆç»Ÿè®¡ä¸åŒæœåŠ¡çš„é”™è¯¯æ—¥å¿—æ•°é‡ã€‚
* å¸¸ä¸ Kibana æ­é…å¯è§†åŒ–å±•ç¤ºã€‚

### 3. ç”¨æˆ·è¡Œä¸ºåˆ†æ

```bash
GET /events/_search
{
  "size": 0,
  "aggs": {
    "daily_active_users": {
      "date_histogram": {
        "field": "timestamp",
        "calendar_interval": "day"
      },
      "aggs": {
        "unique_users": {"cardinality": {"field": "user_id"}}
      }
    }
  }
}
```

* ç”¨é€”ï¼šç»Ÿè®¡æ¯æ—¥æ´»è·ƒç”¨æˆ·æ•°ï¼ˆDAUï¼‰ã€‚

### 4. è‡ªåŠ¨è¡¥å…¨ï¼ˆæœç´¢å»ºè®®ï¼‰

```bash
GET /suggest-demo/_search
{
  "suggest": {
    "product-suggest": {
      "prefix": "iph",
      "completion": {"field": "suggest"}
    }
  }
}
```

* ä½¿ç”¨ `completion` å­—æ®µç±»å‹å®ç°è‡ªåŠ¨è¡¥å…¨åŠŸèƒ½ã€‚

### 5. åœ°ç†ä½ç½®æœç´¢

```bash
GET /stores/_search
{
  "query": {
    "bool": {
      "filter": {
        "geo_distance": {
          "distance": "5km",
          "location": {"lat": 35.6895, "lon": 139.6917}
        }
      }
    }
  }
}
```

* ç”¨é€”ï¼šæŸ¥æ‰¾è·ç¦»ç”¨æˆ·å½“å‰ä½ç½® 5 å…¬é‡Œå†…çš„é—¨åº—ã€‚



```shell
# è¿›å…¥å®¹å™¨
docker exec -it elasticsearch bash
# é‡ç½®å¯†ç 
bin/elasticsearch-reset-password -u elastic
```

