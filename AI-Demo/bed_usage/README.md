# 医院病床使用情况可视化大屏

这是一个用于实时监控香港医院病床使用情况的可视化大屏系统。

## 功能特点

- **占用率展示**：显示各医院及科室的病床使用率
- **空闲病床数据**：实时展示空闲病床数量及分布情况
- **病床分布情况**：通过热力图展示不同医院和科室的病床使用情况
- **信息概览**：总病床数、已用病床数、空闲病床数和整体使用率的实时数据

## 技术栈

- **后端**：Python + Flask
- **前端**：HTML + CSS + JavaScript
- **数据可视化**：ECharts
- **数据处理**：Pandas

## 系统架构流程图

### 1. 系统启动与初始化流程 (Main Flow)

                    +----------------------------+
                    |        Start app.py        |
                    +-------------+--------------+
                                  |
                                  v
                +--------------------------------------------+
                |      Init logging module: setup_logging()   |
                +-----------------+----------------------------+
                                  |
                                  v
                +--------------------------------------------+
                |   Create logs/ directory & logs/app.log     |
                +-----------------+----------------------------+
                                  |
                                  v
                +--------------------------------------------+
                |   Init cache directory: init_cache_paths    |
                +-----------------+----------------------------+
                                  |
                                  v
                +--------------------------------------------------------+
                |  Try load disk cache: caches/data_cache.pkl ?          |
                +--------------------------+-----------------------------+
                                           |
                             +-------------+-------------+
                             |                           |
                             | YES                       | NO
                             v                           v
           +--------------------------------+     +--------------------------------------+
           |   Memory _cache updated        |     |  Trigger async_precompute()          |
           +---------------+----------------+     +----------------+---------------------+
                           |                                      |
                           v                                      v
                     +------------------+                   +------------------+
                     | Start Flask      |                   | Start Flask      |
                     | Server : 8989    |                   | Server : 8989    |
                     +------------------+                   +------------------+


### 2. 数据缓存与更新策略 (Caching Strategy)

                      Client Request /api/xxx
                                |
                                v
+-------------------------------------------------------------+
| 1. Is memory cache (_cache) available?                      |
+------------------------------+------------------------------+
                               |
                 +-------------+-----------------------+
                 |                                     |
                 | YES                                 | NO
                 v                                     v
     Return memory result (FASTEST)     +-----------------------------+
                 |                      | 2. Is disk cache exists?    |
                 v                      +--------------+--------------+
               END                                     |
                                        +--------------+------------+
                                        |                           |
                                        | NO                        | YES
                                        v                           v
                          +------------------------------+   +----------------------------+
                          | Trigger async_precompute()   |   | 3. Is disk cache newer     |
                          +---------------+--------------+   |    than Excel file?        |
                                          |                  +-------------+--------------+
                                          v                                |
                             Return empty/loading                          |
                             (temporary)                                   |
                                          |                                |
                                          v                                v
                                        END                    +----------------------------+
                                                               |  Load disk cache ->        |
                                                               |  write to memory           |
                                                               +-------------+--------------+
                                                                           |
                                                                           v
                                                                   Return memory data
                                                                           |
                                                                           v
                                                                           END

                                                           (If NO)
                                                             |
                                                             v
                                             Trigger async_precompute()
                                                             |
                                                             v
                                             Return empty/loading (temporary)



### 3. 日志模块架构 (Logging Architecture)

+--------------------------------------------------------------+
|                       configs/logger.py                      |
+----------------------------+---------------------------------+
                             |
                             v
                 +------------------------+
                 |     setup_logging      |
                 +-----------+------------+
                             |
         +-------------------+--------------------+
         |                                        |
         v                                        v
+--------------------------+        +---------------------------+
| Formatter                |        | RotatingFileHandler       |
| (Time - Name - Level...) |        | (10MB x 5 backup)         |
+--------------------------+        +------------+--------------+
                                                |
                                                v
                                    +--------------------------+
                                    |       logs/ directory     |
                                    +-----------+--------------+
                                                |
                                                v
                                    +--------------------------+
                                    |       app.log file       |
                                    +--------------------------+
                                                |
                                                v
                                    +---------------------------+
                                    |      StreamHandler        |
                                    |    (Console Output)       |
                                    +---------------------------+


+---------------------------------------------------------------+
|                           调用方                               |
+--------------------+----------------------+-------------------+
                     |                      |
                     v                      v
            +---------------+       +-------------------------+
            |    app.py     |       |    cache_manager.py     |
            +-------+-------+       +-----------+-------------+
                    |                           |
                    v                           v
            +---------------------------------------------+
            |              LoggerInstance                 |
            +-------------------+-------------------------+
                                |
                                v
                     Sends logs to setup_logging


## 快速开始

1. 安装依赖：

```bash
pip install flask pandas openpyxl matplotlib seaborn
```

2. 运行应用：

```bash
python app.py
```

3. 访问系统：

在浏览器中打开 `http://127.0.0.1:8989`

## 文件结构

- `app.py` - Flask应用主程序
- `hospital_bed_usage_data.xlsx` - 病床使用数据源
- `templates/index.html` - 可视化大屏前端界面
- `configs/logger.py` - 日志配置文件
- `caches/cache_manager.py` - 缓存管理模块
- `view_excel_data.py` - 数据分析脚本(辅助工具)

## 可视化图表说明

- **总体概况**：显示数据概览和科室空闲病床分布饼图
- **各医院病床使用率**：横向条形图展示各医院的病床使用率
- **主要科室病床使用率**：柱状图展示主要科室的病床使用率
- **医院-科室病床使用率热力图**：用热力图展示各医院各科室的病床使用情况
