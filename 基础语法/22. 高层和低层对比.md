# **Python asyncio é«˜å±‚ vs åº•å±‚äº‹ä»¶å¾ªçŽ¯æ‰§è¡Œæœºåˆ¶å¯¹æ¯”å›¾**
---

### ðŸ§­ é«˜å±‚ APIï¼ˆ`asyncio.run()`ï¼‰â€”â€”è‡ªåŠ¨ç®¡ç†äº‹ä»¶å¾ªçŽ¯

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      asyncio.run(main())                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
[1] åˆ›å»ºäº‹ä»¶å¾ªçŽ¯ (loop)
        â”‚
        â–¼
[2] å°† main() å°è£…ä¸º Task
        â”‚
        â–¼
[3] å¯åŠ¨ loop.run_until_complete(main_task)
        â”‚
        â–¼
[4] ç­‰å¾…æ‰€æœ‰ await å®Œæˆ
        â”‚
        â–¼
[5] è‡ªåŠ¨å…³é—­äº‹ä»¶å¾ªçŽ¯ (loop.close)
        â”‚
        â–¼
[âœ… ç¨‹åºç»“æŸï¼Œloop ä¸å¯å¤ç”¨]
```

ðŸŸ¢ ç‰¹ç‚¹ï¼š

* è‡ªåŠ¨åˆ›å»ºä¸Žå…³é—­ loop
* æ— éœ€ç®¡ç†ç”Ÿå‘½å‘¨æœŸ
* æ— æ³•åµŒå¥—ï¼ˆJupyter ä¸­ä¼šæŠ¥ â€œevent loop already runningâ€ï¼‰
* é€‚åˆçŸ­å‘½ä»¤è„šæœ¬ã€ä¸€å£æ°”è·‘å®Œçš„ä»»åŠ¡

---

### âš™ï¸ åº•å±‚ APIï¼ˆ`get_event_loop()` / `new_event_loop()`ï¼‰â€”â€”æ‰‹åŠ¨æŽ§åˆ¶å¾ªçŽ¯

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          æ‰‹åŠ¨ç®¡ç†äº‹ä»¶å¾ªçŽ¯ (frameworkçº§)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
[1] loop = asyncio.new_event_loop()
        â”‚
        â–¼
[2] asyncio.set_event_loop(loop)
        â”‚
        â–¼
[3] åˆ›å»ºä»»åŠ¡ task = loop.create_task(coro)
        â”‚
        â–¼
[4] loop.run_until_complete(task)
        â”‚
        â–¼
[5] å¯ç»§ç»­è¿½åŠ ä»»åŠ¡ loop.create_task(...)
        â”‚
        â–¼
[6] æœ€åŽæ‰‹åŠ¨ loop.close()
        â”‚
        â–¼
[âœ… ç¨‹åºå¯é•¿æœŸè¿è¡Œ / æ¡†æž¶å¸¸é©»]
```

ðŸ”µ ç‰¹ç‚¹ï¼š

* å®Œå…¨æŽŒæŽ§ loop ç”Ÿå‘½å‘¨æœŸ
* å¯åœ¨åŽå°é•¿æœŸè¿è¡Œï¼ˆå¦‚ Web æœåŠ¡å™¨ã€Agent è°ƒåº¦å™¨ï¼‰
* æ”¯æŒå¤šä¸ª loop å¹¶è¡Œï¼ˆä¸åŒçº¿ç¨‹ï¼‰
* é€‚åˆéœ€è¦æŒç»­è°ƒåº¦çš„ç³»ç»Ÿï¼ˆå¦‚ FastAPIã€aiohttpã€å®šæ—¶ä»»åŠ¡ï¼‰

---

### ðŸ§© ç®€è¦å¯¹æ¯”æ€»ç»“

| é¡¹ç›®   | é«˜å±‚ `asyncio.run()` | åº•å±‚ loop æŽ§åˆ¶    |
| ---- | ------------------ | ------------- |
| æŽ§åˆ¶æƒ  | è‡ªåŠ¨                 | æ‰‹åŠ¨            |
| ç”Ÿå‘½å‘¨æœŸ | è‡ªåŠ¨åˆ›å»º + è‡ªåŠ¨å…³é—­        | è‡ªè¡Œç»´æŠ¤          |
| å¯é‡ç”¨æ€§ | âŒ ä¸å¯é‡ç”¨             | âœ… å¯é‡ç”¨         |
| åµŒå¥—æ”¯æŒ | âŒ ä¸å¯åµŒå¥—             | âœ… å¯åµŒå¥—         |
| å…¸åž‹åœºæ™¯ | è„šæœ¬ / æ•°æ®å¤„ç†          | Web æ¡†æž¶ / åŽå°æœåŠ¡ |
| ä½¿ç”¨ä½“éªŒ | ç®€æ´ã€å®‰å…¨              | çµæ´»ã€å¤æ‚         |



å¥½çš„ âœ…
è¿™é‡Œæ˜¯ä¸€ä»½å®Œæ•´çš„å¯è§†åŒ–æ–‡æ¡£ï¼š
èžåˆäº†ã€Œä¸‰ç§ä»»åŠ¡æ‰§è¡Œæ¨¡åž‹æ—¶é—´è½´å¯¹æ¯”å›¾ã€ä¸Žã€Œäº‹ä»¶å¾ªçŽ¯çš„å†…éƒ¨è°ƒåº¦æœºåˆ¶å›¾ã€ï¼Œ
å¸®ä½ ä»Žâ€œä¸Šå±‚è¡Œä¸ºâ€åˆ°â€œåº•å±‚æœºåˆ¶â€ç³»ç»Ÿç†è§£ Python çš„ä»»åŠ¡æ‰§è¡Œæ¨¡åž‹ã€‚

---

# ç¤ºä¾‹: ðŸ§© Python ä»»åŠ¡æ‰§è¡Œæœºåˆ¶æ€»è§ˆ

## â€”â€”åŒæ­¥ vs å¼‚æ­¥é¡ºåº vs å¼‚æ­¥å¹¶å‘ + Event Loop è°ƒåº¦åŽŸç†

---

## ðŸŽ¬ ä¸€ã€ä¸‰ç§æ‰§è¡Œæ¨¡åž‹å¯¹æ¯”

å‡è®¾æœ‰ä¸‰ä¸ªä»»åŠ¡ï¼š

* A â†’ è€—æ—¶ 2 ç§’
* B â†’ è€—æ—¶ 1 ç§’
* C â†’ è€—æ—¶ 3 ç§’

---

### 1ï¸âƒ£ åŒæ­¥æ‰§è¡Œï¼ˆé˜»å¡žï¼‰

```python
taskA()
taskB()
taskC()
```

```
æ—¶é—´ â†’
0s         1s         2s         3s         4s         5s         6s
â”‚----------â”‚----------â”‚----------â”‚----------â”‚----------â”‚----------â”‚
A è¿è¡Œä¸­================== å®Œæˆ
B           ================== å®Œæˆ
C                             ========================= å®Œæˆ
æ€»è€—æ—¶ï¼š6 ç§’
```

ðŸ§  **æœºåˆ¶è¯´æ˜Žï¼š**

* ä»»åŠ¡é¡ºåºæ‰§è¡Œï¼›
* CPU ä¸€ç›´è¢«å½“å‰ä»»åŠ¡å ç”¨ï¼›
* æ— æ³•åˆ©ç”¨ I/O ç©ºé—²æ—¶é—´ï¼›
* æ€§èƒ½ç“¶é¢ˆæ˜Žæ˜¾ã€‚

---

### 2ï¸âƒ£ å¼‚æ­¥é¡ºåºæ‰§è¡Œï¼ˆawait é¡ºåºç­‰å¾…ï¼‰

```python
await taskA()
await taskB()
await taskC()
```

```
æ—¶é—´ â†’
0s         1s         2s         3s         4s         5s         6s
â”‚----------â”‚----------â”‚----------â”‚----------â”‚----------â”‚----------â”‚
A è¿è¡Œä¸­================== å®Œæˆ
B           ================== å®Œæˆ
C                             ========================= å®Œæˆ
æ€»è€—æ—¶ï¼š6 ç§’
```

ðŸ§  **æœºåˆ¶è¯´æ˜Žï¼š**

* `await` è®©å‡ºæŽ§åˆ¶æƒï¼›
* ä½†ä»ç„¶æ˜¯â€œä¸€ä¸ªä»»åŠ¡ä¸€ä¸ªä»»åŠ¡ç­‰å®Œâ€ï¼›
* æ²¡æœ‰å¹¶å‘è°ƒåº¦ï¼›
* çœ‹èµ·æ¥å¼‚æ­¥ï¼Œä½†è¡Œä¸ºä»æ˜¯é¡ºåºã€‚

---

### 3ï¸âƒ£ å¼‚æ­¥å¹¶å‘æ‰§è¡Œï¼ˆäº‹ä»¶å¾ªçŽ¯è°ƒåº¦ï¼‰

```python
await asyncio.gather(
    taskA(),
    taskB(),
    taskC()
)
```

```
æ—¶é—´ â†’
0s         1s         2s         3s         4s
â”‚----------â”‚----------â”‚----------â”‚----------â”‚
A è¿è¡Œä¸­================== å®Œæˆ
B è¿è¡Œä¸­========== å®Œæˆ
C è¿è¡Œä¸­=========================== å®Œæˆ
æ€»è€—æ—¶ï¼šâ‰ˆ3 ç§’ï¼ˆæœ€é•¿ä»»åŠ¡æ—¶é—´ï¼‰
```

ðŸ§  **æœºåˆ¶è¯´æ˜Žï¼š**

* æ‰€æœ‰ coroutine è¢«åŒæ—¶æ³¨å†Œè¿›äº‹ä»¶å¾ªçŽ¯ï¼›
* å½“æŸä¸ªä»»åŠ¡ `await`ï¼ˆè¿›å…¥ I/O ç­‰å¾…ï¼‰æ—¶ï¼Œloop ç«‹åˆ»åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªï¼›
* æ²¡æœ‰ CPU é˜»å¡žï¼›
* å®žçŽ°â€œå¹¶å‘ä½†éžå¹¶è¡Œâ€ï¼ˆå•çº¿ç¨‹ä¸‹å¤šä»»åŠ¡äº¤æ›¿ï¼‰ã€‚

---

## âš™ï¸ äºŒã€äº‹ä»¶å¾ªçŽ¯å†…éƒ¨è°ƒåº¦æœºåˆ¶å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        asyncio.run(main)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
     [1] åˆ›å»ºäº‹ä»¶å¾ªçŽ¯ loop
             â”‚
             â–¼
     [2] æ³¨å†Œä»»åŠ¡ï¼ˆcoroutinesï¼‰
             â”‚
             â–¼
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚         äº‹ä»¶å¾ªçŽ¯å¾ªçŽ¯ä½“       â”‚
 â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
 â”‚ â”‚   å°±ç»ªä»»åŠ¡é˜Ÿåˆ— (ready)  â”‚ â”‚
 â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
 â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
 â”‚ â”‚   ç­‰å¾…ä»»åŠ¡é˜Ÿåˆ— (await)  â”‚ â”‚
 â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
 â”‚          â†“è°ƒåº¦              â”‚
 â”‚   â–¶ å–å‡ºå°±ç»ªä»»åŠ¡æ‰§è¡Œä¸€æ¬¡
 â”‚   â–¶ é‡åˆ° await â†’ æŒ‚èµ·
 â”‚   â–¶ åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªä»»åŠ¡
 â”‚   â–¶ é‡å¤è½®è½¬ç›´åˆ°æ‰€æœ‰å®Œæˆ
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
     [3] å…³é—­äº‹ä»¶å¾ªçŽ¯ loop
```

ðŸ” **å…³é”®æœºåˆ¶ï¼š**

* **å•çº¿ç¨‹äº‹ä»¶å¾ªçŽ¯ï¼ˆEvent Loopï¼‰** è°ƒåº¦ coroutineï¼›
* æ¯æ¬¡åªè¿è¡Œä¸€ä¸ªä»»åŠ¡çš„å¯æ‰§è¡Œéƒ¨åˆ†ï¼›
* **I/O ç­‰å¾…æ—¶ç«‹å³åˆ‡æ¢ä»»åŠ¡**ï¼›
* é€šè¿‡â€œåä½œå¼è®©å‡ºæŽ§åˆ¶æƒâ€å®žçŽ°å¹¶å‘ï¼›
* å¹¶éžå¤šçº¿ç¨‹ / å¤šè¿›ç¨‹ï¼ˆæ— å¹¶è¡Œï¼‰ã€‚

---

## ðŸ§  ä¸‰ã€å±‚æ¬¡ç†è§£æ€»ç»“

| å±‚çº§          | åç§°                                | æŽ§åˆ¶æƒ    | æ‰§è¡Œæ¨¡åž‹               | å…¸åž‹åº”ç”¨              |
| ----------- | --------------------------------- | ------ | ------------------ | ----------------- |
| ðŸ§© **é«˜å±‚å°è£…** | `asyncio.run(main())`             | è‡ªåŠ¨     | è‡ªåŠ¨åˆ›å»º/å…³é—­ loopï¼Œä¸€æ¬¡æ€§ä»»åŠ¡ | è„šæœ¬ã€çˆ¬è™«ã€æ•°æ®æŠ“å–        |
| âš™ï¸ **åº•å±‚æŽ§åˆ¶** | `loop = asyncio.get_event_loop()` | æ‰‹åŠ¨     | æ‰‹åŠ¨åˆ›å»ºã€è°ƒåº¦ã€å…³é—­ loop    | Web æ¡†æž¶ã€åŽå°æœåŠ¡ã€Agent |
| ðŸŒ€ **æ ¸å¿ƒæœºåˆ¶** | äº‹ä»¶å¾ªçŽ¯ (Event Loop)                 | å†…éƒ¨è‡ªåŠ¨è°ƒåº¦ | åç¨‹è½®è½¬æ‰§è¡Œ             | asyncio å†…æ ¸ã€å¼‚æ­¥ I/O |

---

## ðŸš€ å››ã€ä¸€å¥è¯æ€»ç»“

> ðŸ§  **Python å¼‚æ­¥ = å•çº¿ç¨‹ + å¤šä»»åŠ¡ + åä½œè°ƒåº¦**
> ä¸æ˜¯å¤šæ ¸å¹¶è¡Œï¼Œè€Œæ˜¯â€œè°ç­‰å¾… I/Oï¼Œè°è®©å‡ºæŽ§åˆ¶æƒâ€ï¼›
> `asyncio` çš„é«˜å±‚æŽ¥å£è®©ä½ è½»æ¾ä½¿ç”¨è¿™ä¸€æœºåˆ¶ï¼Œ
> è€Œåº•å±‚ loop API è®©æ¡†æž¶å’Œè°ƒåº¦ç³»ç»Ÿèƒ½å®Œå…¨æŽŒæŽ§å®ƒã€‚
