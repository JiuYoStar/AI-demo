
## ğŸ Python ç”Ÿæˆå™¨æ¨¡æ‹Ÿ LLM æµå¼è¾“å‡º

```python
import time

# æ¨¡æ‹Ÿä¸€ä¸ª LLM é€å­—ç”Ÿæˆç­”æ¡ˆ
def llm_stream_answer(text):
    for word in text.split():
        time.sleep(0.5)   # æ¨¡æ‹Ÿå»¶è¿Ÿ
        yield word

# è°ƒç”¨ç”Ÿæˆå™¨
for chunk in llm_stream_answer("ä½ å¥½ æˆ‘ æ˜¯ ä¸€ä¸ª æ¨¡æ‹Ÿ çš„ LLM"):
    print(chunk, end=" ", flush=True)

# è¾“å‡º (é€æ­¥æ‰“å°)
# ä½ å¥½ -> æˆ‘ -> æ˜¯ -> ä¸€ä¸ª -> æ¨¡æ‹Ÿ -> çš„ -> LLM
```

---

## ğŸŒ å¯¹åº”çš„ JS (async generator)

```javascript
// æ¨¡æ‹Ÿå¼‚æ­¥æµå¼è¾“å‡º
async function* llmStreamAnswer(text) {
  for (let word of text.split(" ")) {
    await new Promise(r => setTimeout(r, 500)); // æ¨¡æ‹Ÿå»¶è¿Ÿ
    yield word;
  }
}

// ä½¿ç”¨
for await (let chunk of llmStreamAnswer("ä½ å¥½ æˆ‘ æ˜¯ ä¸€ä¸ª æ¨¡æ‹Ÿ çš„ LLM")) {
  process.stdout.write(chunk + " ");
}
```

---

### ğŸ“Œ åº”ç”¨åœºæ™¯

* **Web æ¡†æ¶**ï¼ˆFastAPIã€Expressï¼‰ï¼šLLM API çš„ **æµå¼å“åº” (SSE/WebSocket)**
* **ChatGPT/Claude**ï¼šç”¨æˆ·æé—®åï¼Œç­”æ¡ˆä¸€è¾¹ç”Ÿæˆä¸€è¾¹è¿”å›ï¼Œä¸ç”¨ç­‰å…¨éƒ¨å®Œæˆ
* **æ—¥å¿— / æ•°æ®æµå¤„ç†**ï¼šå®æ—¶é€æ¡å¤„ç†ï¼Œè€Œä¸æ˜¯ä¸€æ¬¡æ€§åŠ è½½

---

ğŸ‘‰ ç»“è®ºï¼š
Python çš„ `yield`ï¼ˆç”Ÿæˆå™¨ï¼‰å’Œ JS çš„ `async function*`ï¼ˆå¼‚æ­¥ç”Ÿæˆå™¨ï¼‰ **éƒ½å¯ä»¥å®ç°æµå¼ç”Ÿæˆï¼Œéå¸¸é€‚åˆåš LLM æ¨ç†è¾“å‡º**ã€‚



# ğŸ FastAPI + ğŸŒ å‰ç«¯ JS å®ç° LLM æµå¼è¾“å‡º Demo

## 1ï¸âƒ£ åç«¯ï¼šFastAPI (Python)

```python
from fastapi import FastAPI
from fastapi.responses import StreamingResponse
import time

app = FastAPI()

# æ¨¡æ‹Ÿ LLM æµå¼ç”Ÿæˆ
def llm_stream_answer(prompt: str):
    for word in f"ä½ æé—®çš„æ˜¯: {prompt}, æˆ‘æ­£åœ¨æµå¼ç”Ÿæˆç­”æ¡ˆ...".split():
        time.sleep(0.5)   # æ¨¡æ‹Ÿå»¶è¿Ÿ
        yield word + " "  # æ¯æ¬¡è¿”å›ä¸€ä¸ªåˆ†ç‰‡

@app.get("/chat")
async def chat(prompt: str):
    return StreamingResponse(llm_stream_answer(prompt), media_type="text/plain")
```

å¯åŠ¨æœåŠ¡ï¼š

```bash
uvicorn app:app --reload
```

---

## 2ï¸âƒ£ å‰ç«¯ï¼šHTML + JS (fetch æµå¼å¤„ç†)

```html
<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>LLM æµå¼è¾“å‡º Demo</title>
</head>
<body>
  <h2>LLM æµå¼è¾“å‡º Demo</h2>
  <input id="prompt" value="ä½ å¥½" />
  <button onclick="ask()">æé—®</button>
  <pre id="output"></pre>

  <script>
    async function ask() {
      const prompt = document.getElementById("prompt").value;
      const output = document.getElementById("output");
      output.textContent = ""; // æ¸…ç©ºå†å²

      const response = await fetch(`/chat?prompt=${encodeURIComponent(prompt)}`);
      const reader = response.body.getReader();
      const decoder = new TextDecoder();

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        output.textContent += decoder.decode(value, { stream: true });
      }
    }
  </script>
</body>
</html>
```

---

## ğŸ“Œ æµç¨‹è¯´æ˜

1. **åç«¯** ç”¨ FastAPI æä¾› `/chat` æ¥å£ï¼Œè¿”å› `StreamingResponse`ï¼ˆç”Ÿæˆå™¨é€å—äº§å‡ºï¼‰
2. **å‰ç«¯** ç”¨ `fetch()`ï¼Œé€šè¿‡ **ReadableStream** è¾¹è¯»è¾¹æ˜¾ç¤º
3. æ•ˆæœï¼šåƒ ChatGPT ä¸€æ ·ï¼Œç­”æ¡ˆä¼šé€æ­¥æ‰“å°å‡ºæ¥ï¼Œè€Œä¸æ˜¯ä¸€æ¬¡æ€§è¿”å›



```python
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 asyncio                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å¹¶å‘ä»»åŠ¡è°ƒåº¦ (Task & å¹¶å‘æ‰§è¡Œ)              â”‚
â”‚   â”œâ”€ asyncio.gather(*coros)       â†’ å¹¶å‘æ‰§è¡Œå¹¶æ”¶é›†ç»“æœ
â”‚   â”œâ”€ asyncio.create_task(coro)    â†’ å¯åŠ¨å•ä¸ªä»»åŠ¡ (è¿”å› Task)
â”‚   â”œâ”€ asyncio.wait(tasks)          â†’ ç­‰å¾…ä»»åŠ¡å®Œæˆ(æ”¯æŒæ¡ä»¶)
â”‚   â”œâ”€ asyncio.as_completed(tasks)  â†’ æŒ‰å®Œæˆé¡ºåºå¼‚æ­¥è·å–ç»“æœ
â”‚   â””â”€ asyncio.shield(coro)         â†’ é˜²æ­¢ä»»åŠ¡è¢«å–æ¶ˆ
â”‚
â”‚  åŒæ­¥/äº’æ–¥ä¸é€šä¿¡æ§åˆ¶ (Synchronization)       â”‚
â”‚   â”œâ”€ asyncio.Lock()               â†’ åç¨‹é”
â”‚   â”œâ”€ asyncio.Semaphore(n)         â†’ é™åˆ¶å¹¶å‘æ•°é‡
â”‚   â”œâ”€ asyncio.Event()              â†’ äº‹ä»¶åŒæ­¥
â”‚   â””â”€ asyncio.Queue()              â†’ å¼‚æ­¥å®‰å…¨é˜Ÿåˆ—
â”‚
â”‚  è¶…æ—¶ä¸ä»»åŠ¡å–æ¶ˆ (Timeout & Cancel)            â”‚
â”‚   â”œâ”€ asyncio.wait_for(coro, t)    â†’ è®¾ç½®ä»»åŠ¡è¶…æ—¶
â”‚   â”œâ”€ asyncio.timeout(t) [3.11+]   â†’ ä¸Šä¸‹æ–‡ç®¡ç†å¼è¶…æ—¶æ§åˆ¶
â”‚   â””â”€ task.cancel()                â†’ ä¸»åŠ¨å–æ¶ˆä»»åŠ¡
â”‚
â”‚  äº‹ä»¶å¾ªç¯æ§åˆ¶ (Event Loop)                   â”‚
â”‚   â”œâ”€ asyncio.run(main())          â†’ å¯åŠ¨äº‹ä»¶å¾ªç¯
â”‚   â”œâ”€ asyncio.get_running_loop()   â†’ è·å–å½“å‰å¾ªç¯
â”‚   â”œâ”€ await asyncio.sleep(0)       â†’ è®©å‡ºæ§åˆ¶æƒ
â”‚   â””â”€ loop.run_in_executor()       â†’ åœ¨çº¿ç¨‹/è¿›ç¨‹æ± ä¸­æ‰§è¡ŒåŒæ­¥ä»»åŠ¡
â”‚
â”‚  ä½å±‚ä»»åŠ¡/ç»“æœç»“æ„ (åº•å±‚å·¥å…·)                 â”‚
â”‚   â”œâ”€ asyncio.Task                 â†’ åç¨‹åŒ…è£…å¯¹è±¡
â”‚   â””â”€ asyncio.Future               â†’ å¼‚æ­¥ç»“æœå®¹å™¨
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

| æƒ³åšä»€ä¹ˆ         | ç”¨å“ªä¸ª                              |
| ------------ | -------------------------------- |
| ğŸ” åŒæ—¶è·‘å¤šä¸ªä»»åŠ¡   | `asyncio.gather` / `create_task` |
| â± é™åˆ¶å¹¶å‘æ•°é‡     | `Semaphore`                      |
| ğŸ§± å¼‚æ­¥é˜Ÿåˆ—é€šä¿¡    | `Queue`                          |
| ğŸ§© æŒ‰å®Œæˆé¡ºåºè·å–ç»“æœ | `as_completed`                   |
| â›” è®¾ç½®è¶…æ—¶       | `wait_for` / `timeout`           |
| ğŸ§µ è·‘åŒæ­¥ä»£ç      | `run_in_executor`                |
| ğŸ”’ é˜²æ­¢å†²çª      | `Lock`                           |
| ğŸ§â€â™‚ï¸ ç­‰å¾…ä¿¡å·   | `Event`                          |


```

