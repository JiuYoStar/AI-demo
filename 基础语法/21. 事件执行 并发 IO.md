
# ğŸ“˜ **ã€ŠPython å¼‚æ­¥ä»»åŠ¡ä¸æ‰§è¡Œæœºåˆ¶å…¨è§£æã€‹**

---

# ğŸ§  ä¸€ã€ä»»åŠ¡æœºåˆ¶æ€»è§ˆï¼ˆTask Mechanism Overviewï¼‰

| å±‚çº§                | ç±»å‹                                 | æ§åˆ¶æ–¹å¼       | ä¼˜ç‚¹          | å…¸å‹åœºæ™¯       |
| ----------------- | ---------------------------------- | ---------- | ----------- | ---------- |
| **å¤šè¿›ç¨‹**           | `multiprocessing`                  | æ“ä½œç³»ç»Ÿçº§åˆ«è¿›ç¨‹   | å¤šæ ¸å¹¶è¡Œï¼ŒCPUå¯†é›†å‹ | å›¾åƒå¤„ç†ã€ç§‘å­¦è®¡ç®—  |
| **å¤šçº¿ç¨‹**           | `threading` / `concurrent.futures` | OSçº§çº¿ç¨‹è°ƒåº¦    | I/O å¹¶è¡Œ      | æ–‡ä»¶ä¸‹è½½ã€ç½‘ç»œè¯·æ±‚  |
| **åç¨‹ï¼ˆCoroutineï¼‰** | `asyncio` / `trio`                 | ç”¨æˆ·çº§è°ƒåº¦ï¼ˆå•çº¿ç¨‹ï¼‰ | é«˜å¹¶å‘ I/Oã€ä½å¼€é”€ | ç½‘ç»œæœåŠ¡ã€ä»£ç†ã€çˆ¬è™« |

ğŸ‘‰ Python çš„å¼‚æ­¥æœºåˆ¶å±äº**åç¨‹çº§å¹¶å‘**ï¼Œå®Œå…¨ç”± **äº‹ä»¶å¾ªç¯ï¼ˆEvent Loopï¼‰** é©±åŠ¨ã€‚

---

# âš™ï¸ äºŒã€Python `asyncio` çš„æ‰§è¡Œæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               ç”¨æˆ·ä»£ç å±‚                    â”‚
â”‚---------------------------------------------â”‚
â”‚ async def main():                           â”‚
â”‚     await asyncio.gather(task1(), task2())  â”‚
â”‚---------------------------------------------â”‚
â”‚               è°ƒåº¦ä¸ä»»åŠ¡å±‚                  â”‚
â”‚ asyncio.Task(Task_1) â”€â”€â–º coroutine_1        â”‚
â”‚ asyncio.Task(Task_2) â”€â”€â–º coroutine_2        â”‚
â”‚---------------------------------------------â”‚
â”‚               äº‹ä»¶å¾ªç¯å±‚ (EventLoop)        â”‚
â”‚  loop._ready       â†’ å°±ç»ªä»»åŠ¡é˜Ÿåˆ—           â”‚
â”‚  loop._scheduled   â†’ å®šæ—¶ä»»åŠ¡é˜Ÿåˆ—           â”‚
â”‚  loop._selector    â†’ I/O ç­‰å¾…æœºåˆ¶ (epoll)   â”‚
â”‚---------------------------------------------â”‚
â”‚               ç³»ç»Ÿåº•å±‚                     â”‚
â”‚  æ“ä½œç³»ç»Ÿäº‹ä»¶é€šçŸ¥ï¼šepoll / kqueue / IOCP    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

# ğŸ” ä¸‰ã€äº‹ä»¶å¾ªç¯çš„ç”Ÿå‘½å‘¨æœŸï¼ˆEvent Loop Lifecycleï¼‰

### 1ï¸âƒ£ åˆ›å»º

```python
loop = asyncio.get_event_loop()
```

æˆ–ä½¿ç”¨é«˜å±‚å°è£…ï¼š

```python
asyncio.run(main())
```

`asyncio.run()` ä¼šï¼š

* åˆ›å»ºäº‹ä»¶å¾ªç¯
* æŠŠ `main()` å°è£…æˆ Task
* å¯åŠ¨å¾ªç¯ç›´åˆ°ä»»åŠ¡å®Œæˆ

---

### 2ï¸âƒ£ æ³¨å†Œä»»åŠ¡

äº‹ä»¶å¾ªç¯ç®¡ç†æ‰€æœ‰å¾…æ‰§è¡Œçš„ä»»åŠ¡ï¼š

* `loop.create_task(coro)`
* æˆ–é€šè¿‡ `asyncio.gather` è‡ªåŠ¨åˆ›å»º Task

---

### 3ï¸âƒ£ è°ƒåº¦ä¸åˆ‡æ¢

å½“åç¨‹æ‰§è¡Œ `await` æ—¶ï¼š

1. å½“å‰ä»»åŠ¡æŒ‚èµ·ï¼Œäº‹ä»¶å¾ªç¯è®°ä¸‹â€œç­‰å¾…çš„ Futureâ€
2. åˆ‡æ¢å»æ‰§è¡Œå…¶ä»–å°±ç»ªä»»åŠ¡ï¼ˆä¸é˜»å¡çº¿ç¨‹ï¼‰
3. å½“ I/O å®Œæˆæˆ–æ—¶é—´åˆ°è¾¾ï¼Œäº‹ä»¶å¾ªç¯å›è°ƒæ¢å¤ä»»åŠ¡

---

### 4ï¸âƒ£ ä»»åŠ¡æ¢å¤ä¸å®Œæˆ

ç­‰å¾…æ¡ä»¶æ»¡è¶³æ—¶ï¼ˆå¦‚ I/O å®Œæˆã€sleep åˆ°æœŸï¼‰ï¼š

* æŠŠä»»åŠ¡æ”¾å› `_ready` é˜Ÿåˆ—
* ä¸‹ä¸€æ¬¡äº‹ä»¶å¾ªç¯ tick æ—¶æ¢å¤æ‰§è¡Œ
* å½“è¿”å›ç»“æœ â†’ Task çŠ¶æ€è½¬ä¸º `FINISHED`

---

# ğŸ§µ å››ã€Taskã€Coroutineã€Future å…³ç³»å›¾

```
Coroutine â”€â”€â”€â–¶ Task â”€â”€â”€â–¶ Future
   â†‘              â†‘
 async def    asyncio.create_task()
```

| åç§°            | å®šä¹‰                     | ä½œç”¨         |
| ------------- | ---------------------- | ---------- |
| **Coroutine** | ç”¨ `async def` å®šä¹‰çš„å¯æš‚åœå‡½æ•° | å®šä¹‰å¼‚æ­¥é€»è¾‘     |
| **Task**      | åç¨‹çš„å¯è°ƒåº¦å•å…ƒï¼Œç”±äº‹ä»¶å¾ªç¯ç®¡ç†       | æ³¨å†Œå¹¶æ‰§è¡Œåç¨‹    |
| **Future**    | è¡¨ç¤ºã€Œæœªæ¥çš„ç»“æœã€çš„å¯¹è±¡           | Task çš„åº•å±‚æœºåˆ¶ |

---

### ç¤ºä¾‹ï¼š

```python
import asyncio

async def work(name, delay):
    await asyncio.sleep(delay)
    print(f"{name} done")
    return name

async def main():
    coro = work("A", 2)              # coroutine å¯¹è±¡
    task = asyncio.create_task(coro) # åˆ›å»ºä»»åŠ¡
    result = await task              # ç­‰å¾…æ‰§è¡Œç»“æœ
    print(result)

asyncio.run(main())
```

---

# âš¡ äº”ã€ä»»åŠ¡è°ƒåº¦æœºåˆ¶è¯¦è§£

### 1ï¸âƒ£ å¹¶å‘è°ƒåº¦

```python
await asyncio.gather(a(), b())
```

â†’ åŒæ—¶è°ƒåº¦å¤šä¸ªä»»åŠ¡ï¼Œç›´åˆ°å…¨éƒ¨å®Œæˆã€‚

### 2ï¸âƒ£ é¡ºåºæ‰§è¡Œ

```python
await a()
await b()
```

â†’ æ¯æ¬¡ç­‰å¾…å‰ä¸€ä¸ªæ‰§è¡Œå®Œï¼Œçº¯é¡ºåºã€‚

### 3ï¸âƒ£ å»¶è¿Ÿä¸ç¡çœ 

```python
await asyncio.sleep(1)
```

â†’ å°†ä»»åŠ¡æŒ‚èµ·ä¸€ç§’ï¼Œäº¤è¿˜æ§åˆ¶æƒï¼Œä¸é˜»å¡çº¿ç¨‹ã€‚

### 4ï¸âƒ£ æ‰‹åŠ¨ä»»åŠ¡æ§åˆ¶

```python
task = asyncio.create_task(coro)
task.cancel()         # å–æ¶ˆä»»åŠ¡
await task            # æ•è· CancelledError
```

### 5ï¸âƒ£ é™åˆ¶å¹¶å‘æ•°é‡

```python
sem = asyncio.Semaphore(3)
async with sem:
    await work()
```

### 6ï¸âƒ£ è¶…æ—¶

```python
await asyncio.wait_for(work(), timeout=5)
```

---

# ğŸ§© å…­ã€ä»»åŠ¡çŠ¶æ€è¿ç§»å›¾

```
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚  PENDING   â”‚
       â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
              â”‚ create_task()
              â–¼
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚  RUNNING   â”‚
       â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
              â”‚ await (I/O or sleep)
              â–¼
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚  SUSPENDED â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”
       â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜         â”‚
              â”‚ resume()      â”‚
              â–¼               â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚ cancel()
       â”‚  FINISHED  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

# ğŸ§  ä¸ƒã€äº‹ä»¶å¾ªç¯çš„åº•å±‚å®ç°ï¼ˆI/O æ¨¡å‹ï¼‰

| å¹³å°      | ä½¿ç”¨çš„ç³»ç»Ÿæœºåˆ¶ | å¯¹åº” Python å†…éƒ¨å®ç°             |
| ------- | ------- | -------------------------- |
| Linux   | epoll   | `selectors.EpollSelector`  |
| macOS   | kqueue  | `selectors.KqueueSelector` |
| Windows | IOCP    | `ProactorEventLoop`        |

äº‹ä»¶å¾ªç¯æ ¸å¿ƒæ“ä½œï¼š

```python
selector.select(timeout)
```

â†’ ç­‰å¾… I/O å°±ç»ªæˆ–è¶…æ—¶ã€‚
â†’ ä¸€æ—¦äº‹ä»¶å°±ç»ªï¼Œæ‰§è¡Œå›è°ƒï¼ˆæ¢å¤åç¨‹ï¼‰ã€‚

---

# ğŸ’¡ å…«ã€Python vs JavaScript å¯¹æ¯”ï¼ˆéå¸¸å…³é”®ï¼‰

| ç»´åº¦     | Python (asyncio)        | JavaScript            |
| ------ | ----------------------- | --------------------- |
| è¯­è¨€å±‚æœºåˆ¶  | ç”¨æˆ·æ€åç¨‹                   | å¼•æ“çº§ä»»åŠ¡é˜Ÿåˆ—               |
| å¹¶å‘æ¨¡å‹   | å•çº¿ç¨‹åç¨‹åˆ‡æ¢                 | å•çº¿ç¨‹äº‹ä»¶å¾ªç¯               |
| ä»»åŠ¡ç±»å‹   | Task/Future             | å®ä»»åŠ¡ / å¾®ä»»åŠ¡             |
| è°ƒåº¦æ—¶æœº   | `await` ä¸»åŠ¨è®©å‡º            | å¾®ä»»åŠ¡è‡ªåŠ¨åœ¨æ¯è½®å¾ªç¯åæ‰§è¡Œ         |
| ä¸»å¾ªç¯åˆ›å»º  | `asyncio.run()`         | è‡ªåŠ¨å­˜åœ¨ï¼ˆç”±å¼•æ“ç®¡ç†ï¼‰           |
| I/O æœºåˆ¶ | epoll/kqueue            | libuv (Node.js)       |
| è¶…æ—¶ç­‰å¾…   | `await asyncio.sleep()` | `setTimeout()`        |
| å¹¶å‘æ”¶é›†   | `asyncio.gather()`      | `Promise.all()`       |
| åç¨‹åˆ‡æ¢   | æ˜¾å¼ await                | éšå¼ promise resolution |

### ç®€åŒ–ç±»æ¯”ï¼š

| JavaScript         | Python ç­‰ä»·          |
| ------------------ | ------------------ |
| `async function()` | `async def`        |
| `await`            | `await`            |
| `Promise.all()`    | `asyncio.gather()` |
| `setTimeout()`     | `asyncio.sleep()`  |
| å¾®ä»»åŠ¡é˜Ÿåˆ—              | `_ready` é˜Ÿåˆ—        |
| å®ä»»åŠ¡é˜Ÿåˆ—              | `_scheduled` é˜Ÿåˆ—    |

---

# ğŸ” ä¹ã€ç¤ºä¾‹ï¼šå¹¶å‘ vs éå¹¶å‘ æ€§èƒ½å·®å¼‚

```python
import asyncio
import time

async def task(name, delay):
    await asyncio.sleep(delay)
    print(f"{name} done")

# éå¹¶å‘ï¼ˆé¡ºåºï¼‰
async def sequential():
    t0 = time.perf_counter()
    await task('A', 2)
    await task('B', 1)
    print(f"é¡ºåºè€—æ—¶: {time.perf_counter() - t0:.2f}s")

# å¹¶å‘ï¼ˆåŒæ—¶è°ƒåº¦ï¼‰
async def concurrent():
    t0 = time.perf_counter()
    await asyncio.gather(task('A', 2), task('B', 1))
    print(f"å¹¶å‘è€—æ—¶: {time.perf_counter() - t0:.2f}s")

asyncio.run(sequential())
asyncio.run(concurrent())
```

è¾“å‡ºï¼š

```
A done
B done
é¡ºåºè€—æ—¶: 3.00s

B done
A done
å¹¶å‘è€—æ—¶: 2.00s
```

---

# ğŸ§® åã€ä¸åŒæ­¥é˜»å¡çš„æ··åˆä½¿ç”¨

å½“ä½ éœ€è¦åœ¨å¼‚æ­¥ä»»åŠ¡ä¸­æ‰§è¡Œè€—æ—¶çš„åŒæ­¥å‡½æ•°ï¼ˆCPU å¯†é›†å‹ï¼‰ï¼Œç”¨ï¼š

```python
loop = asyncio.get_running_loop()
result = await loop.run_in_executor(None, blocking_function)
```

è¿™ä¼šåœ¨çº¿ç¨‹æ± æˆ–è¿›ç¨‹æ± ä¸­æ‰§è¡ŒåŒæ­¥ä»»åŠ¡ï¼Œä¸é˜»å¡ä¸»åç¨‹ã€‚

---

# âœ… åä¸€ã€å°ç»“ï¼šä¸€å›¾æ€»ç»“ Python å¼‚æ­¥æ‰§è¡Œæœºåˆ¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ async def main():                           â”‚
â”‚     await asyncio.gather(a(), b())          â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ asyncio.gather()                            â”‚
â”‚ â”œâ”€ åˆ›å»º Task(TaskA)                         â”‚
â”‚ â”œâ”€ åˆ›å»º Task(TaskB)                         â”‚
â”‚ â””â”€ è°ƒåº¦åˆ°äº‹ä»¶å¾ªç¯ loop                      â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ loop.run_forever():                         â”‚
â”‚  â”œâ”€ æ‰§è¡Œ _ready é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡                â”‚
â”‚  â”œâ”€ ç›‘å¬ _scheduled å®šæ—¶ä»»åŠ¡                â”‚
â”‚  â”œâ”€ ä½¿ç”¨ epoll/kqueue ç›‘å¬ I/O äº‹ä»¶          â”‚
â”‚  â””â”€ å½“ await å®Œæˆ â†’ å°†ä»»åŠ¡æ”¾å› _ready       â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ æœ€åï¼šæ‰€æœ‰ä»»åŠ¡å®Œæˆ â†’ åœæ­¢å¾ªç¯ â†’ è¿”å›ç»“æœ     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

# ğŸ’¬ åäºŒã€æœ€ç®€è®°å¿†æ³•æ€»ç»“

| æƒ³å¹²å˜›         | ç”¨å“ªä¸ªå‡½æ•°                      |
| ----------- | -------------------------- |
| ğŸš€ å¯åŠ¨å¼‚æ­¥ä¸»ç¨‹åº  | `asyncio.run()`            |
| âš™ï¸ æ³¨å†Œä»»åŠ¡     | `create_task()`            |
| ğŸ§© å¹¶å‘æ‰§è¡Œå¤šä¸ªä»»åŠ¡ | `asyncio.gather()`         |
| ğŸ’¤ ç­‰å¾…ä½†ä¸é˜»å¡   | `await asyncio.sleep()`    |
| â± è®¾ç½®è¶…æ—¶      | `wait_for()` / `timeout()` |
| ğŸ§± å¼‚æ­¥é€šä¿¡     | `Queue` / `Event`          |
| ğŸ”’ å¹¶å‘æ§åˆ¶     | `Lock` / `Semaphore`       |
| ğŸ§µ çº¿ç¨‹ä¸­è·‘åŒæ­¥ä»»åŠ¡ | `run_in_executor()`        |
