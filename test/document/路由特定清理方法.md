# è·¯ç”±ç‰¹å®šæ¸…ç†æ–¹æ³•

## ğŸ¯ é—®é¢˜

å¦‚ä½•ä¸ºä¸åŒçš„è·¯ç”±æ‰§è¡Œä¸åŒçš„ teardown æ¸…ç†é€»è¾‘?

## ğŸ“Š ä¸‰ç§è§£å†³æ–¹æ¡ˆ

### æ–¹æ³•1: åœ¨ teardown_request ä¸­æ£€æŸ¥è·¯å¾„ â­

```python
@app.before_request
def before():
    g.route_name = request.endpoint  # è®°å½•å½“å‰è·¯ç”±

@app.teardown_request
def teardown_by_path(exception):
    """æ ¹æ®è·¯å¾„æ‰§è¡Œä¸åŒçš„æ¸…ç†"""

    if g.route_name == 'index':
        print("æ¸…ç† index è·¯ç”±çš„èµ„æº")
        # index ç‰¹å®šçš„æ¸…ç†

    elif g.route_name == 'api_route':
        print("æ¸…ç† API è·¯ç”±çš„èµ„æº")
        # API ç‰¹å®šçš„æ¸…ç†

    else:
        print("é€šç”¨æ¸…ç†")
```

**ä¼˜ç‚¹**:
- âœ… é›†ä¸­ç®¡ç†,é€»è¾‘æ¸…æ™°
- âœ… å¯ä»¥è®¿é—®gå¯¹è±¡å’Œrequestå¯¹è±¡
- âœ… çµæ´»,å¯ä»¥æ ¹æ®ä»»ä½•æ¡ä»¶åˆ¤æ–­

**ç¼ºç‚¹**:
- âŒ æ‰€æœ‰è·¯ç”±çš„æ¸…ç†é€»è¾‘éƒ½åœ¨ä¸€ä¸ªå‡½æ•°ä¸­
- âŒ è·¯ç”±å¤šäº†ä»£ç ä¼šå¾ˆé•¿

### æ–¹æ³•2: ä½¿ç”¨è“å›¾çš„ teardown_request â­â­

```python
# åˆ›å»ºè“å›¾
user_bp = Blueprint('user', __name__, url_prefix='/user')
admin_bp = Blueprint('admin', __name__, url_prefix='/admin')

# è“å›¾1çš„teardown
@user_bp.teardown_request
def user_teardown(exception):
    """åªå¯¹ /user/* è·¯ç”±ç”Ÿæ•ˆ"""
    print("æ¸…ç†ç”¨æˆ·æ¨¡å—èµ„æº")
    # å…³é—­ç”¨æˆ·æ•°æ®åº“è¿æ¥ç­‰

@user_bp.route('/profile')
def profile():
    return "User Profile"

# è“å›¾2çš„teardown
@admin_bp.teardown_request
def admin_teardown(exception):
    """åªå¯¹ /admin/* è·¯ç”±ç”Ÿæ•ˆ"""
    print("æ¸…ç†ç®¡ç†å‘˜æ¨¡å—èµ„æº")
    # å…³é—­ç®¡ç†å‘˜æ•°æ®åº“è¿æ¥ç­‰

@admin_bp.route('/dashboard')
def dashboard():
    return "Admin Dashboard"

# æ³¨å†Œè“å›¾
app.register_blueprint(user_bp)
app.register_blueprint(admin_bp)
```

**ä¼˜ç‚¹**:
- âœ… æ¨¡å—åŒ–,æ¯ä¸ªè“å›¾ç‹¬ç«‹
- âœ… è‡ªåŠ¨æ ¹æ®URLå‰ç¼€åŒºåˆ†
- âœ… ä»£ç ç»„ç»‡æ¸…æ™°

**ç¼ºç‚¹**:
- âŒ éœ€è¦ä½¿ç”¨è“å›¾
- âŒ ä¸é€‚åˆå•ä¸ªè·¯ç”±çº§åˆ«çš„æ§åˆ¶

### æ–¹æ³•3: ä½¿ç”¨è£…é¥°å™¨ â­â­â­

```python
from functools import wraps

def with_cleanup(cleanup_func):
    """è£…é¥°å™¨: ä¸ºè·¯ç”±æ·»åŠ æ¸…ç†å‡½æ•°"""
    def decorator(f):
        @wraps(f)
        def wrapper(*args, **kwargs):
            try:
                return f(*args, **kwargs)
            finally:
                cleanup_func()  # æ‰§è¡Œæ¸…ç†
        return wrapper
    return decorator

# å®šä¹‰æ¸…ç†å‡½æ•°
def cleanup_index():
    print("æ¸…ç† index è·¯ç”±")

def cleanup_api():
    print("æ¸…ç† API è·¯ç”±")

# ä½¿ç”¨è£…é¥°å™¨
@app.route('/')
@with_cleanup(cleanup_index)
def index():
    return "Hello"

@app.route('/api/data')
@with_cleanup(cleanup_api)
def api_data():
    return "Data"
```

**ä¼˜ç‚¹**:
- âœ… ç²¾ç¡®æ§åˆ¶,æ¯ä¸ªè·¯ç”±ç‹¬ç«‹
- âœ… æ¸…ç†å‡½æ•°å¯å¤ç”¨
- âœ… çµæ´»,å¯ä»¥ä¼ é€’å‚æ•°

**ç¼ºç‚¹**:
- âŒ éœ€è¦ä¸ºæ¯ä¸ªè·¯ç”±æ·»åŠ è£…é¥°å™¨
- âŒ finallyå—åœ¨teardownä¹‹å‰æ‰§è¡Œ

## ğŸ“Š å¯¹æ¯”è¡¨æ ¼

| æ–¹æ³• | ç²’åº¦ | å¤æ‚åº¦ | æ¨èåº¦ | é€‚ç”¨åœºæ™¯ |
|------|------|--------|--------|---------|
| æ£€æŸ¥è·¯å¾„ | åº”ç”¨çº§ | ä¸­ | â­ | è·¯ç”±ä¸å¤šæ—¶ |
| è“å›¾teardown | è“å›¾çº§ | ä½ | â­â­ | æ¨¡å—åŒ–åº”ç”¨ |
| è£…é¥°å™¨ | è·¯ç”±çº§ | ä½ | â­â­â­ | ç²¾ç¡®æ§åˆ¶ |

## ğŸ” å®é™…æµ‹è¯•

### æµ‹è¯•æ–¹æ³•1 (æ£€æŸ¥è·¯å¾„)

```bash
# å¯åŠ¨åº”ç”¨
python test.py

# åœ¨å¦ä¸€ä¸ªç»ˆç«¯æµ‹è¯•
curl http://127.0.0.1:5000/
# è¾“å‡º:
# ğŸŸ¢ [Before Request] è·¯å¾„: /, è·¯ç”±: index
# ğŸ”µ [Index Route] å¤„ç†é¦–é¡µè¯·æ±‚
# âš« [Decorator Cleanup] æ‰§è¡Œ index çš„æ¸…ç†
#    âœ… Indexè·¯ç”±ä¸“å±æ¸…ç†å®Œæˆ
# âš« [Teardown Request] æ¸…ç†è·¯ç”±: index
#    âœ… æ‰§è¡Œ index è·¯ç”±çš„ä¸“å±æ¸…ç†
# âš« [Global Teardown 2] è·¯ç”±: index
# âš« [Global Teardown 1] è·¯ç”±: index

curl http://127.0.0.1:5000/slow
# è¾“å‡º:
# ğŸŸ¢ [Before Request] è·¯å¾„: /slow, è·¯ç”±: slow_route
# ğŸ”µ [Slow Route] å¤„ç†æ…¢è¯·æ±‚
# âš« [Decorator Cleanup] æ‰§è¡Œ slow_route çš„æ¸…ç†
#    âœ… Slowè·¯ç”±ä¸“å±æ¸…ç†å®Œæˆ
# âš« [Teardown Request] æ¸…ç†è·¯ç”±: slow_route
#    âœ… æ‰§è¡Œ slow è·¯ç”±çš„ä¸“å±æ¸…ç†
# âš« [Global Teardown 2] è·¯ç”±: slow_route
# âš« [Global Teardown 1] è·¯ç”±: slow_route
```

### æµ‹è¯•æ–¹æ³•2 (è“å›¾)

```bash
curl http://127.0.0.1:5000/user/profile
# è¾“å‡º:
# ğŸŸ¢ [Before Request] è·¯å¾„: /user/profile, è·¯ç”±: user.user_profile
# ğŸ”µ [User Route] å¤„ç†ç”¨æˆ·èµ„æ–™è¯·æ±‚
# âš« [User Blueprint Teardown] æ¸…ç†ç”¨æˆ·æ¨¡å—èµ„æº  â† åªæœ‰ç”¨æˆ·è“å›¾çš„teardown
#    è·¯ç”±: user.user_profile
# âš« [Teardown Request] æ¸…ç†è·¯ç”±: user.user_profile
#    â„¹ï¸  é€šç”¨æ¸…ç† (è·¯ç”±: user.user_profile)
# âš« [Global Teardown 2] è·¯ç”±: user.user_profile
# âš« [Global Teardown 1] è·¯ç”±: user.user_profile

curl http://127.0.0.1:5000/admin/dashboard
# è¾“å‡º:
# ğŸŸ¢ [Before Request] è·¯å¾„: /admin/dashboard, è·¯ç”±: admin.admin_dashboard
# ğŸ”µ [Admin Route] å¤„ç†ç®¡ç†å‘˜ä»ªè¡¨ç›˜è¯·æ±‚
# âš« [Admin Blueprint Teardown] æ¸…ç†ç®¡ç†å‘˜æ¨¡å—èµ„æº  â† åªæœ‰ç®¡ç†å‘˜è“å›¾çš„teardown
#    è·¯ç”±: admin.admin_dashboard
# âš« [Teardown Request] æ¸…ç†è·¯ç”±: admin.admin_dashboard
#    â„¹ï¸  é€šç”¨æ¸…ç† (è·¯ç”±: admin.admin_dashboard)
# âš« [Global Teardown 2] è·¯ç”±: admin.admin_dashboard
# âš« [Global Teardown 1] è·¯ç”±: admin.admin_dashboard
```

## ğŸ“ æ‰§è¡Œé¡ºåº

### å®Œæ•´çš„æ‰§è¡Œé¡ºåº:

```
1. before_request (å…¨å±€)
2. before_request (è“å›¾çº§åˆ«) - å¦‚æœæœ‰
   â†“
3. è§†å›¾å‡½æ•°
   â†“
4. è£…é¥°å™¨çš„ finally å— - å¦‚æœæœ‰
5. after_request (è“å›¾çº§åˆ«) - å¦‚æœæœ‰
6. after_request (å…¨å±€)
   â†“
7. teardown_request (è“å›¾çº§åˆ«) - å¦‚æœæœ‰
8. teardown_request (å…¨å±€)
9. teardown_appcontext (åæ³¨å†Œçš„å…ˆæ‰§è¡Œ,LIFO)
```

### ä¸ºä»€ä¹ˆ teardown æ˜¯ LIFO?

```python
# æ³¨å†Œé¡ºåº
@app.teardown_appcontext  # 1. å…ˆæ³¨å†Œ
def cleanup_db():
    close_db()

@app.teardown_appcontext  # 2. åæ³¨å†Œ,ä¾èµ–æ•°æ®åº“
def cleanup_cache():
    save_to_db()  # éœ€è¦æ•°æ®åº“è¿˜å¼€ç€
    clear_cache()

# æ‰§è¡Œé¡ºåº (LIFO - åè¿›å…ˆå‡º)
# 1. cleanup_cache()  â† åæ³¨å†Œ,å…ˆæ‰§è¡Œ(æ­¤æ—¶æ•°æ®åº“è¿˜å¼€ç€)
# 2. cleanup_db()     â† å…ˆæ³¨å†Œ,åæ‰§è¡Œ(ä¿å­˜ç¼“å­˜åå†å…³é—­æ•°æ®åº“)
```

**è®¾è®¡åŸå› **: ä¿è¯åé¢çš„æ¸…ç†å‡½æ•°å¯ä»¥ä½¿ç”¨å‰é¢çš„èµ„æº!

## ğŸ’¡ æ¨èæ–¹æ¡ˆ

### å°å‹åº”ç”¨ (è·¯ç”±<20ä¸ª)

ä½¿ç”¨**æ–¹æ³•1**: åœ¨teardownä¸­æ£€æŸ¥è·¯å¾„

### ä¸­å¤§å‹åº”ç”¨ (æ¨¡å—åŒ–)

ä½¿ç”¨**æ–¹æ³•2**: è“å›¾çš„teardown_request

### éœ€è¦ç²¾ç¡®æ§åˆ¶

ä½¿ç”¨**æ–¹æ³•3**: è£…é¥°å™¨æ¨¡å¼

### ç»„åˆä½¿ç”¨ (æœ€ä½³å®è·µ)

```python
# å…¨å±€teardown: å¤„ç†é€šç”¨èµ„æº
@app.teardown_request
def global_teardown(exception):
    db = g.pop('db', None)
    if db:
        db.close()

# è“å›¾teardown: å¤„ç†æ¨¡å—ç‰¹å®šèµ„æº
@user_bp.teardown_request
def user_teardown(exception):
    # æ¸…ç†ç”¨æˆ·æ¨¡å—ç‰¹å®šèµ„æº
    pass

# è£…é¥°å™¨: å¤„ç†ç‰¹æ®Šè·¯ç”±
@app.route('/special')
@with_cleanup(cleanup_special)
def special():
    return "Special"
```

## ğŸ“ æ€»ç»“

| éœ€æ±‚ | æ¨èæ–¹æ³• |
|------|---------|
| æ ¹æ®ä¸åŒè·¯å¾„æ¸…ç† | æ–¹æ³•1: æ£€æŸ¥g.route_name |
| æ¨¡å—åŒ–æ¸…ç† | æ–¹æ³•2: è“å›¾teardown |
| å•ä¸ªè·¯ç”±ç‰¹æ®Šæ¸…ç† | æ–¹æ³•3: è£…é¥°å™¨ |

---

**æ‰€æœ‰æ–¹æ³•éƒ½å¯ä»¥å…±å­˜!æ ¹æ®å®é™…éœ€æ±‚é€‰æ‹©åˆé€‚çš„æ–¹æ¡ˆã€‚** ğŸ¯

