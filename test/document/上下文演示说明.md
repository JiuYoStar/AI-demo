# Flask ä¸Šä¸‹æ–‡æ¼”ç¤ºè¯´æ˜

## ğŸ¯ æ¼”ç¤ºå†…å®¹

åˆ›å»ºäº†ä¸€ä¸ªä¸“é—¨çš„è“å›¾ `context_demo` æ¥æ¼”ç¤ºFlaskçš„è¯·æ±‚ä¸Šä¸‹æ–‡å’Œåº”ç”¨ä¸Šä¸‹æ–‡ã€‚

## ğŸ“‹ æ¼”ç¤ºè·¯ç”±åˆ—è¡¨

| è·¯ç”± | è¯´æ˜ |
|------|------|
| `/context/route1` | åŸºæœ¬çš„gå¯¹è±¡ä½¿ç”¨ |
| `/context/route2` | æ¼”ç¤ºä¸åŒè¯·æ±‚æœ‰ç‹¬ç«‹çš„gå¯¹è±¡ |
| `/context/multi-call` | åŒä¸€è¯·æ±‚ä¸­å¤šæ¬¡è®¿é—®gå¯¹è±¡ |
| `/context/slow-request` | æ¨¡æ‹Ÿæ…¢è¯·æ±‚,éªŒè¯çº¿ç¨‹å®‰å…¨ |
| `/context/context-stack` | æŸ¥çœ‹ä¸Šä¸‹æ–‡æ ˆä¿¡æ¯ |
| `/context/app-context-demo` | åº”ç”¨ä¸Šä¸‹æ–‡æ¼”ç¤º |
| `/context/summary` | ä¸Šä¸‹æ–‡å¯¹æ¯”æ€»ç»“ |

## ğŸš€ å¦‚ä½•æµ‹è¯•

### 1. å¯åŠ¨åº”ç”¨

```bash
cd /Users/lingk/work/py/demo/flask-demo1
source venv/bin/activate
flask run
```

### 2. æµ‹è¯•å•ä¸ªè¯·æ±‚

```bash
# æµ‹è¯•route1
curl "http://127.0.0.1:5000/context/route1?user=Alice"

# æŸ¥çœ‹ç»ˆç«¯è¾“å‡º,ä¼šæ˜¾ç¤º:
# ğŸŸ¢ğŸŸ¢ğŸŸ¢... [Before Request] è¯·æ±‚ä¸Šä¸‹æ–‡å·²åˆ›å»º
# ğŸ”µğŸ”µğŸ”µ... [Route 1] åœ¨è§†å›¾å‡½æ•°ä¸­
# ğŸŸ¢ğŸŸ¢ğŸŸ¢... [After Request] è¯·æ±‚å³å°†ç»“æŸ
# âš«âš«âš«... [Teardown Request] æ¸…ç†è¯·æ±‚ä¸Šä¸‹æ–‡
```

### 3. å¯¹æ¯”ä¸åŒè¯·æ±‚

```bash
# è¯·æ±‚1
curl "http://127.0.0.1:5000/context/route1?user=Alice"

# è¯·æ±‚2 (æ³¨æ„:ä¸åŒçš„user)
curl "http://127.0.0.1:5000/context/route2?user=Bob"

# è§‚å¯Ÿ: æ¯ä¸ªè¯·æ±‚éƒ½æœ‰ç‹¬ç«‹çš„gå¯¹è±¡,gå¯¹è±¡IDä¸åŒ
```

### 4. æµ‹è¯•å¤šæ¬¡è°ƒç”¨

```bash
curl "http://127.0.0.1:5000/context/multi-call?user=Charlie"

# è§‚å¯Ÿ: helper1, helper2, helper3 å…±äº«åŒä¸€ä¸ªgå¯¹è±¡
# gå¯¹è±¡IDç›¸åŒ
```

### 5. æµ‹è¯•å¹¶å‘è¯·æ±‚

```bash
# åœ¨å¤šä¸ªç»ˆç«¯åŒæ—¶æ‰§è¡Œ:
curl "http://127.0.0.1:5000/context/slow-request?user=User1" &
curl "http://127.0.0.1:5000/context/slow-request?user=User2" &
curl "http://127.0.0.1:5000/context/slow-request?user=User3" &

# è§‚å¯Ÿ: è™½ç„¶è¯·æ±‚åŒæ—¶å¤„ç†,ä½†gå¯¹è±¡äº’ä¸å¹²æ‰°
# User1çš„g.userå§‹ç»ˆæ˜¯"User1",ä¸ä¼šå˜æˆUser2æˆ–User3
```

### 6. æŸ¥çœ‹ä¸Šä¸‹æ–‡ä¿¡æ¯

```bash
curl "http://127.0.0.1:5000/context/context-stack"
curl "http://127.0.0.1:5000/context/summary"
```

## ğŸ“Š è¯·æ±‚å¤„ç†æµç¨‹

```
HTTPè¯·æ±‚åˆ°è¾¾
    â†“
ã€åˆ›å»ºè¯·æ±‚ä¸Šä¸‹æ–‡ã€‘
    â†“
ğŸŸ¢ before_request (å…¨å±€)
    - åˆå§‹åŒ– g.user, g.request_id, g.start_time
    - æ‰“å°è¯·æ±‚ä¿¡æ¯
    â†“
ğŸŸ¢ before_request (è“å›¾çº§åˆ«)
    - è“å›¾ç‰¹å®šçš„åˆå§‹åŒ–
    â†“
ğŸ”µ è§†å›¾å‡½æ•° (route1, route2ç­‰)
    - ä½¿ç”¨ g å¯¹è±¡
    - è°ƒç”¨è¾…åŠ©å‡½æ•°(å…±äº«gå¯¹è±¡)
    - è¿”å›å“åº”
    â†“
ğŸŸ¢ after_request (è“å›¾çº§åˆ«)
    - æ·»åŠ è“å›¾ç‰¹å®šçš„å“åº”å¤´
    â†“
ğŸ”´ after_request (å…¨å±€)
    - è®¡ç®—å¤„ç†æ—¶é—´
    - æ·»åŠ å“åº”å¤´
    - æ‰“å°å“åº”æ—¥å¿—
    â†“
âš« teardown_request (è“å›¾çº§åˆ«)
    - æ¸…ç†è“å›¾èµ„æº
    â†“
âš« teardown_request (å…¨å±€)
    - å…³é—­æ•°æ®åº“è¿æ¥
    - æ¸…ç†èµ„æº
    â†“
ã€é”€æ¯è¯·æ±‚ä¸Šä¸‹æ–‡ã€‘
    â†“
è¿”å›HTTPå“åº”
```

## ğŸ¨ ç»ˆç«¯è¾“å‡ºç¤ºä¾‹

### å•ä¸ªè¯·æ±‚çš„å®Œæ•´è¾“å‡º:

```
ğŸŸ¢ğŸŸ¢ğŸŸ¢ğŸŸ¢ğŸŸ¢ğŸŸ¢ğŸŸ¢ğŸŸ¢ğŸŸ¢ğŸŸ¢ğŸŸ¢ğŸŸ¢ğŸŸ¢ğŸŸ¢ğŸŸ¢ğŸŸ¢ğŸŸ¢ğŸŸ¢ğŸŸ¢ğŸŸ¢ğŸŸ¢ğŸŸ¢ğŸŸ¢ğŸŸ¢ğŸŸ¢ğŸŸ¢ğŸŸ¢ğŸŸ¢ğŸŸ¢ğŸŸ¢ğŸŸ¢ğŸŸ¢ğŸŸ¢ğŸŸ¢ğŸŸ¢
ã€Before Requestã€‘è¯·æ±‚ä¸Šä¸‹æ–‡å·²åˆ›å»º
======================================================================
  ğŸ“ è¯·æ±‚è·¯å¾„: /context/route1
  ğŸ“ è¯·æ±‚æ–¹æ³•: GET
  ğŸ“ è¯·æ±‚å‚æ•°: {'user': 'Alice'}
  ğŸ“ åº”ç”¨åç§°: app
  ğŸ“ g.user: Alice
  ğŸ“ g.request_id: REQ-1234567890
  ğŸ“ gå¯¹è±¡ID: 140234567890
======================================================================

ğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µ
ã€Route 1ã€‘åœ¨è§†å›¾å‡½æ•°ä¸­
======================================================================
  ğŸ“Œ g.user: Alice
  ğŸ“Œ g.request_id: REQ-1234567890
  ğŸ“Œ g.custom_data: {'flag': 'before_request'}
  ğŸ“Œ gå¯¹è±¡ID: 140234567890
  ğŸ“Œ request.path: /context/route1
  ğŸ“Œ request.endpoint: context_demo.route1
  ğŸ“Œ current_app.name: app
======================================================================

ğŸŸ¢ğŸŸ¢ğŸŸ¢ğŸŸ¢ğŸŸ¢ğŸŸ¢ğŸŸ¢ğŸŸ¢ğŸŸ¢ğŸŸ¢ğŸŸ¢ğŸŸ¢ğŸŸ¢ğŸŸ¢ğŸŸ¢ğŸŸ¢ğŸŸ¢ğŸŸ¢ğŸŸ¢ğŸŸ¢ğŸŸ¢ğŸŸ¢ğŸŸ¢ğŸŸ¢ğŸŸ¢ğŸŸ¢ğŸŸ¢ğŸŸ¢ğŸŸ¢ğŸŸ¢ğŸŸ¢ğŸŸ¢ğŸŸ¢ğŸŸ¢ğŸŸ¢
ã€After Request - Blueprintã€‘è“å›¾çº§åˆ«çš„after_request
======================================================================
  ğŸ“Œ g.user: Alice
  ğŸ“Œ å“åº”çŠ¶æ€: 200
======================================================================

ğŸ”´ğŸ”´ğŸ”´ğŸ”´ğŸ”´ğŸ”´ğŸ”´ğŸ”´ğŸ”´ğŸ”´ğŸ”´ğŸ”´ğŸ”´ğŸ”´ğŸ”´ğŸ”´ğŸ”´ğŸ”´ğŸ”´ğŸ”´ğŸ”´ğŸ”´ğŸ”´ğŸ”´ğŸ”´ğŸ”´ğŸ”´ğŸ”´ğŸ”´ğŸ”´ğŸ”´ğŸ”´ğŸ”´ğŸ”´ğŸ”´
ã€After Requestã€‘è¯·æ±‚å³å°†ç»“æŸ
======================================================================
  ğŸ“ æ€»è€—æ—¶: 0.0023s
  ğŸ“ ç”¨æˆ·: Alice
  ğŸ“ è¯·æ±‚ID: REQ-1234567890
  ğŸ“ å“åº”çŠ¶æ€ç : 200
  ğŸ“ gå¯¹è±¡ID: 140234567890
======================================================================

âš«âš«âš«âš«âš«âš«âš«âš«âš«âš«âš«âš«âš«âš«âš«âš«âš«âš«âš«âš«âš«âš«âš«âš«âš«âš«âš«âš«âš«âš«âš«âš«âš«âš«âš«
ã€Teardown Requestã€‘æ¸…ç†è¯·æ±‚ä¸Šä¸‹æ–‡
======================================================================
  ğŸ“ æ¸…ç†ç”¨æˆ·: Alice
  ğŸ“ è¯·æ±‚ID: REQ-1234567890
  âœ… è¯·æ±‚æ­£å¸¸ç»“æŸ
======================================================================
ğŸ è¯·æ±‚ä¸Šä¸‹æ–‡å³å°†é”€æ¯
```

## ğŸ” å…³é”®è§‚å¯Ÿç‚¹

### 1. gå¯¹è±¡IDå§‹ç»ˆç›¸åŒ

åœ¨åŒä¸€ä¸ªè¯·æ±‚ä¸­:
```
before_request: gå¯¹è±¡ID = 140234567890
route1:        gå¯¹è±¡ID = 140234567890  â† ç›¸åŒ!
after_request:  gå¯¹è±¡ID = 140234567890  â† ç›¸åŒ!
teardown:      gå¯¹è±¡ID = 140234567890  â† ç›¸åŒ!
```

### 2. ä¸åŒè¯·æ±‚çš„gå¯¹è±¡ä¸åŒ

```
è¯·æ±‚1: gå¯¹è±¡ID = 140234567890, g.user = "Alice"
è¯·æ±‚2: gå¯¹è±¡ID = 140234567891, g.user = "Bob"
```

### 3. gå¯¹è±¡çš„å˜é‡ç´¯ç§¯

åœ¨åŒä¸€ä¸ªè¯·æ±‚ä¸­:
```
before_request:  è®¾ç½® g.user, g.request_id
route1:         å¯ä»¥è®¿é—® g.user, g.request_id
                æ·»åŠ  g.route_name
helper_function: å¯ä»¥è®¿é—®æ‰€æœ‰ä¹‹å‰è®¾ç½®çš„å˜é‡
                æ·»åŠ  g.helper1_called
after_request:   å¯ä»¥è®¿é—®æ‰€æœ‰å˜é‡
```

## ğŸ“š æµ‹è¯•å‘½ä»¤æ±‡æ€»

```bash
# åŸºç¡€æµ‹è¯•
curl "http://127.0.0.1:5000/context/route1?user=Alice"
curl "http://127.0.0.1:5000/context/route2?user=Bob"
curl "http://127.0.0.1:5000/context/multi-call?user=Charlie"

# ä¸Šä¸‹æ–‡ä¿¡æ¯
curl "http://127.0.0.1:5000/context/context-stack"
curl "http://127.0.0.1:5000/context/app-context-demo"
curl "http://127.0.0.1:5000/context/summary"

# å¹¶å‘æµ‹è¯•
curl "http://127.0.0.1:5000/context/slow-request?user=User1" &
curl "http://127.0.0.1:5000/context/slow-request?user=User2" &

# å¯¹æ¯”ä¸åŒè¯·æ±‚
curl "http://127.0.0.1:5000/context/compare-requests?user=Request1"
curl "http://127.0.0.1:5000/context/compare-requests?user=Request2"
```

## ğŸ“ å­¦ä¹ è¦ç‚¹

1. **gå¯¹è±¡ç”Ÿå‘½å‘¨æœŸ** = å•ä¸ªè¯·æ±‚
2. **æ¯ä¸ªè¯·æ±‚æœ‰ç‹¬ç«‹çš„gå¯¹è±¡** (ä¸åŒçš„ID)
3. **åŒä¸€è¯·æ±‚ä¸­,æ‰€æœ‰å‡½æ•°å…±äº«åŒä¸€ä¸ªgå¯¹è±¡** (ç›¸åŒçš„ID)
4. **gå¯¹è±¡åœ¨è¯·æ±‚ç»“æŸåè‡ªåŠ¨æ¸…ç†**
5. **gå¯¹è±¡çº¿ç¨‹å®‰å…¨** (å¹¶å‘è¯·æ±‚äº’ä¸å¹²æ‰°)

## ğŸ’¡ å®è·µå»ºè®®

1. è§‚å¯Ÿç»ˆç«¯è¾“å‡ºä¸­çš„**gå¯¹è±¡ID**,ç†è§£å¯¹è±¡ç”Ÿå‘½å‘¨æœŸ
2. å¯¹æ¯”**ä¸åŒè¯·æ±‚**çš„è¾“å‡º,ç†è§£éš”ç¦»æ€§
3. æµ‹è¯•**å¹¶å‘è¯·æ±‚**,ç†è§£çº¿ç¨‹å®‰å…¨
4. æŸ¥çœ‹**å½©è‰²æ ‡è®°**,ç†è§£è¯·æ±‚å¤„ç†æµç¨‹

---

**ç°åœ¨å¯åŠ¨åº”ç”¨,å¼€å§‹æ¢ç´¢Flaskçš„ä¸Šä¸‹æ–‡ç³»ç»Ÿ!** ğŸš€

